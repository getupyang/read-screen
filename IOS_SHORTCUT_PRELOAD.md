# 📱 iOS快捷指令配置（预加载版）

## 目标
实现真正的"Capture Now, Process Later"：
- 截图 → 上传 → **立即触发AI分析**（后台自动）
- 用户晚上打开App时，卡片已经生成好了（0秒等待）

---

## 快捷指令流程（改进版）

### 第1步：基本设置
1. 打开"快捷指令"App
2. 点击右上角 "+" 创建新快捷指令
3. 重命名为 "Snapshot AI"

### 第2步：添加操作

#### 操作1：接收输入
```
获取 [快捷输入]
类型：图像
来源：共享表单
```

#### 操作2：压缩图片
```
调整图像大小
宽度：1500 像素
高度：自动
```

#### 操作3：Base64编码
```
Base64 编码
输入：已调整大小的图像
```

#### 操作4：上传图片
```
URL：https://你的域名.vercel.app/api/analyze
方法：POST
请求体：JSON

内容：
{
  "image": "[Base64编码结果]",
  "source": "shortcut"
}
```

#### 操作5：获取响应
```
获取 URL 内容的值
使用：JSON
```

#### 操作6：提取图片ID（重要！）
```
从 [URL内容] 中获取字典值
键：url
```
（这会得到图片的URL，我们需要从中提取ID）

#### 操作7：触发AI分析（新增！）
```
URL：https://你的域名.vercel.app/api/process
方法：POST
请求体：JSON

内容：
{
  "id": "[从上一步提取的ID]",
  "imageUrl": "[上一步获取的URL]"
}
```

**注意**：这个请求是"Fire and Forget"，不需要等待响应。

#### 操作8：显示通知
```
显示通知
标题：✨ 已保存
正文：正在后台生成卡片...
```

---

## 🔧 实际配置步骤

由于步骤6（提取ID）比较复杂，我们简化一下：

### 简化方案：让后端返回完整信息

修改 `api/analyze.ts`，让它在响应中返回完整的信息，方便快捷指令直接使用。

---

## 📋 快捷指令JSON配置（可导入）

由于iOS快捷指令不支持直接导入JSON，我提供一个更简单的配置方法：

### 方法A：使用iCloud链接分享（推荐）

配置好后，点击快捷指令右上角的分享按钮，生成iCloud链接，就可以在任何iOS设备上安装。

### 方法B：手动配置（详细步骤）

1. **获取共享表单输入**
   - 搜索并添加："获取"
   - 类型选择："快捷输入"

2. **调整图像大小**
   - 搜索并添加："调整图像大小"
   - 宽度：1500

3. **Base64编码**
   - 搜索并添加："Base64编码"

4. **第一个网络请求（上传图片）**
   - 搜索并添加："获取URL内容"
   - URL：`https://你的域名.vercel.app/api/analyze`
   - 方法：POST
   - 请求体：JSON
   - 点击"添加新字段"
   - 键：`image`，值：选择"Base64编码结果"

5. **第二个网络请求（触发分析）**
   - 再次添加："获取URL内容"
   - URL：`https://你的域名.vercel.app/api/trigger-simple`
   - 方法：GET
   - （这会触发所有待处理图片的分析）

6. **显示通知**
   - 搜索并添加："显示通知"
   - 正文：✨ 已保存到Snapshot AI

---

## 🚀 更简单的方案（推荐）

为了避免快捷指令太复杂，我创建一个新的API端点：

### `/api/trigger-simple`

这个API会：
1. 检查所有 `status=uploaded` 的记录
2. 自动触发它们的AI分析
3. 立即返回（不等待完成）

快捷指令只需要：
```
1. 上传图片到 /api/analyze
2. 调用 /api/trigger-simple（GET请求，无需参数）
3. 显示通知
```

---

## 🔄 后续优化方向

### 选项1：Supabase Database Webhook（最优雅）

配置Supabase在图片插入时自动触发Edge Function：
```
Supabase Database Trigger (ON INSERT)
  ↓
Edge Function
  ↓
调用 Gemini API
  ↓
更新记录为 ready
```

这样连快捷指令都不需要改，完全后台自动化。

### 选项2：后台定时任务

在Vercel部署一个Cron Job，每5分钟检查一次是否有待处理的图片。

---

## 下一步

我建议先创建 `/api/trigger-simple` 端点，这样快捷指令的配置会更简单。

你觉得呢？要我现在就实现这个简化版的触发API吗？
